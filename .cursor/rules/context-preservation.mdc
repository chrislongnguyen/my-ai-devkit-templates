---
description: Prevent context loss across long sessions and device switches. Enforces handoff and re-hydration protocols.
alwaysApply: true
---

# Context Preservation Protocol (Hard Rules)

Context window limits and device switches are the #1 silent killer for AI-assisted projects. These rules ensure the User never loses progress regardless of session length or which machine they use.

## Rule 1: Session Start Re-Hydration
At the **start of every session** (first user message after a fresh chat window), before executing any command or task:
1. Read the **active planning doc** (same logic as State B Step 0: `docs/ai/planning/feature-*.md` if exactly one exists, else `README.md` + `CHANGELOG.md`).
2. Read `project_handoff_status.md` in the repo root if it exists (generated by `/handoff`).
3. Briefly confirm to the User: *"Resuming feature [name]. Last approved task: [ID]. Next task: [ID]. Current iteration: [N]."* This costs one read but prevents the agent from starting blind.

## Rule 2: Periodic Checkpoint Nudge
After the agent completes and the User approves **3 consecutive tasks** in a single chat session (3Ã— ðŸŸ¢ Reviewed/Tested in one session), the agent must suggest:
> *"We've completed 3 tasks in this session. To protect against context loss, I recommend running `/handoff` now and then starting a fresh session. This keeps context clean. Shall I run /handoff?"*

The User may decline ("No, continue") â€” this is a nudge, not a hard stop. But the agent must ask.

## Rule 3: Pre-Ship Handoff Reminder
When the User runs `/ship`, before proposing the commit, the agent must check: has `/handoff` been run since the last approved task? If not, remind:
> *"No handoff has been generated since the last approved task. Running `/handoff` alongside `/ship` ensures the next session can resume cleanly. Shall I generate the handoff doc first?"*

## Rule 4: Cross-Device Continuity
The combination of `/handoff` (writes `project_handoff_status.md`) + `/status` (reads planning doc) + git (syncs files across machines) forms a complete cross-device continuity chain:
1. **Before leaving a device:** Run `/handoff` â†’ `/ship` (commit and push the handoff doc + any code).
2. **On the new device:** Pull the latest â†’ Run `/status` (agent re-reads planning doc + handoff doc via Rule 1).

The agent must never assume it has context from a previous session. Always re-read docs first (Rule 1).

## Rule 5: Never Rely on Chat Memory Alone
The planning doc (`docs/ai/planning/feature-{name}.md`) is the **single source of truth** for task state â€” not the chat history. If the chat says a task is ðŸŸ¢ but the planning doc says ðŸ”´, the planning doc wins. Always read before acting.
