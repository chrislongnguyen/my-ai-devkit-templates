# Context Preservation Protocol (Hard Rules)

Context window limits and device switches are the #1 silent killer for AI-assisted projects. These rules ensure the User never loses progress regardless of session length or which machine they use. For approval phrases, recovery protocol, and cross-device continuity, see `docs/ai/Effective_Execution_Manifesto.md`.

## Rule 1: Session Start Re-Hydration
At the **start of every session** (first user message after a fresh chat window), before executing any command or task that depends on the planning doc:
1. **Scope:** Re-hydration applies to all commands **except** `/help` (decision tree only) and `/remember` (memory capture only). For `/help` and `/remember`, skip steps 2â€“3 below.
2. Read the **active planning doc** using the same logic as **execute-micro-task.md Step 0 (Canonical)** â€” only `docs/ai/planning/feature-*.md`, **excluding `docs/ai/archive/`**; if multiple exist, use the most recently modified.
3. Read `project_handoff_status.md` in the repo root if it exists (generated by `/handoff`).
4. Briefly confirm to the User: *"Resuming feature [name]. Last approved task: [ID]. Next task: [ID]. Current iteration: [N]."* This costs one read but prevents the agent from starting blind.

## Rule 2: Periodic Checkpoint Nudge
After the agent completes and the User approves **3 consecutive tasks** in a single chat session (3Ã— ðŸŸ¢ Reviewed/Tested in one session), the agent must suggest:
> *"We've completed 3 tasks in this session. To protect against context loss, I recommend running `/handoff` now and then starting a fresh session. This keeps context clean. Shall I run /handoff?"*

The User may decline ("No, continue") â€” this is a nudge, not a hard stop. But the agent must ask.

## Rule 3: Pre-Ship Handoff Reminder
When the User runs `/ship`, before proposing the commit, the agent must check: has `/handoff` been run since the last approved task? If not, remind:
> *"No handoff has been generated since the last approved task. Running `/handoff` alongside `/ship` ensures the next session can resume cleanly. Shall I generate the handoff doc first?"*

## Rule 4: Cross-Device Continuity
The combination of `/handoff` (writes `project_handoff_status.md`) + `/status` (reads planning doc) + git (syncs files across machines) forms a complete cross-device continuity chain:
1. **Before leaving a device:** Run `/handoff` â†’ `/ship` (commit and push the handoff doc + any code).
2. **On the new device:** Pull the latest â†’ Run `/status` (agent re-reads planning doc + handoff doc via Rule 1).

The agent must never assume it has context from a previous session. Always re-read docs first (Rule 1).

## Rule 5: Never Rely on Chat Memory Alone
The planning doc (`docs/ai/planning/feature-{name}.md`) is the **single source of truth** for task state â€” not the chat history. If the chat says a task is ðŸŸ¢ but the planning doc says ðŸ”´, the planning doc wins. Always read before acting.

## Rule 6: /remember (Optional Utility)
`/remember` persists principles or rules to persistent AI memory (see `engine/commands/remember.md`). It does **not** modify the planning doc or task status. Use it when capturing architecture or requirement decisions you want future sessions to respect. Re-hydration (Rule 1) does not require reading the planning doc when the user runs `/remember` only.
